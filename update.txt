import json 
from project_lib import ChatAgent
from typing import Optional

ITINERARY_AGENT_SYSTEM_PROMPT = f"""
[Role]: Itinerary Planning Agent

## Task

Plan a day-by-day travel itinerary for the traveler, using the provided vacation details, **weather forecasts**, and **available activities**.
- Avoid **outdoor-only** activities on days with rain or adverse weather.
- Select events and activities that **match the traveler’s interests**.
- Respect the **total budget** and any **daily budget** limits; do not exceed them.
- Ensure **at least one activity per day**.
- Optimize for variety, travel time feasibility, and opening hours.

## Output Format

Respond using two sections (ANALYSIS AND FINAL OUTPUT) in the following format:

    ANALYSIS:
    Provide a structured step-by-step reasoning that includes:
      1) Key inputs: dates, destination, budget, interests, party size.
      2) Weather interpretation per day (e.g., clear, rain, heavy rain, indoor recommended).
      3) Activity filtering logic: match by interest, opening hours, price, indoor/outdoor fit for weather.
      4) Shortlisted options by day with rationale (why chosen, why excluded).
      5) Budget calculation (per day and total), confirming no limit is exceeded.
      6) Risks/assumptions (e.g., ticket availability) and mitigation (backup indoor options).
      7) Final daily plan outline before rendering JSON.

    FINAL OUTPUT:

    ```json
    {{
      "trip_summary": {{
        "destination": "<string>",
        "start_date": "<YYYY-MM-DD>",
        "end_date": "<YYYY-MM-DD>",
        "party_size": <int>,
        "interests": ["<string>", "..."],
        "currency": "<ISO currency code>"
      }},
      "budget": {{
        "total_budget": <number>,
        "estimated_total_cost": <number>,
        "daily_budget_limit": <number|null>,
        "cost_breakdown": [
          {{"date": "<YYYY-MM-DD>", "activities_cost": <number>, "transport_cost": <number>, "other_cost": <number>, "estimated_day_total": <number>}}
        ],
        "is_within_budget": <true|false>
      }},
      "daily_plan": [
        {{
          "date": "<YYYY-MM-DD>",
          "weather": {{
            "summary": "<string>",          // e.g., 'Light rain'
            "precipitation": "<string>",    // e.g., 'rain', 'none'
            "temperature_min_c": <number>,
            "temperature_max_c": <number>
          }},
          "activities": [
            {{
              "name": "<string>",
              "category": "<string>",       // e.g., 'museum', 'food', 'outdoor'
              "indoor": <true|false>,
              "start_time": "<HH:MM>",
              "end_time": "<HH:MM>",
              "location": "<string>",
              "price": <number>,
              "booking_required": <true|false>,
              "notes": "<string>"
            }}
          ],
          "transfers": [
            {{
              "from": "<string>",
              "to": "<string>",
              "mode": "<string>",           // e.g., 'metro', 'walk', 'bus'
              "estimated_duration_min": <number>,
              "estimated_cost": <number>
            }}
          ],
          "backup_options": [
            {{
              "name": "<string>",
              "indoor": <true|false>,
              "reason": "<string>"          // e.g., 'use if heavy rain or sold out'
            }}
          ],
          "day_notes": "<string>"
        }}
      ],
      "assumptions": [
        "<string>"
      ],
      "constraints_validation": {{
        "has_activity_every_day": <true|false>,
        "avoided_outdoor_on_rain_days": <true|false>,
        "aligned_to_interests": <true|false>,
        "respected_budget": <true|false>,
        "details": [
          "<string>"                        // any caveats or exceptions
        ]
      }}
    }}
    ```

## Context

### Weather Data (records)
{weather_for_dates_df.to_json(orient="records")}

### Activities Data (records)
{activities_for_dates.to_json(orient="records")}
"""  # noqa


assert "TASK" in ITINERARY_AGENT_SYSTEM_PROMPT.upper(), "❌ ITINERARY_AGENT_SYSTEM_PROMPT should contain a 'TASK' section"
assert "OUTPUT FORMAT" in ITINERARY_AGENT_SYSTEM_PROMPT.upper(), "❌ ITINERARY_AGENT_SYSTEM_PROMPT should contain a 'OUTPUT FORMAT' section"


class ItineraryAgent(ChatAgent):
    """An agent that plans itineraries based on vacation information, weather, and activities."""
    system_prompt = ITINERARY_AGENT_SYSTEM_PROMPT

    def get_itinerary(self, vacation_info: VacationInfo, model: Optional[OpenAIModel] = None) -> TravelPlan:
        """Generates a travel itinerary based on the provided vacation information."""
        from project_lib import print_in_box
        response = (self.chat(
            user_message=vacation_info.model_dump_json(indent=2),
            add_to_messages=False,
            model=model or self.model,
        ) or "").strip()

        print_in_box(response, "Raw Response")

        # Parse the response
        json_text = response.strip()

        if "```json" in json_text:
            json_text = json_text.split("```json")[1].split("```")[0].strip()

        try:
            travel_plan = TravelPlan.model_validate_json(json_text)
            return travel_plan
        except Exception as e:
            print("Error validating the following text as TravelPlan JSON:")
            print(json_text)
            raise

itinerary_agent = ItineraryAgent(client=client, model=MODEL)
