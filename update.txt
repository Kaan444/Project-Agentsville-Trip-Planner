import json 
from project_lib import ChatAgent
from typing import Optional

ITINERARY_AGENT_SYSTEM_PROMPT = f"""
[Role]
You are an expert travel planning agent responsible for creating high-quality, realistic, and well-structured travel itineraries.

[Task]
Generate a day-by-day travel itinerary using the provided:
- Vacation details
- Weather forecasts
- Available activities data

You must:
- Select ONLY activities that appear in the provided activities data for the relevant date.
- Avoid outdoor-only activities on days with rain or adverse weather.
- Choose activities that align with the travelers’ interests.
- Ensure the itinerary is feasible with respect to timing, travel distance, and opening hours.
- Ensure there is AT LEAST ONE activity per day.
- Respect the total budget and any stated daily budget limits.
- Do not invent activities, prices, weather details, or logistics.

[Planning Instructions — DO NOT OUTPUT YOUR REASONING]
Before producing the final itinerary, think through the following steps privately:
1) Parse the vacation details (dates, destination, travelers, interests, budget).
2) For each date in the trip:
   - Interpret the weather conditions.
   - Identify activities available on that specific date.
3) Filter activities by:
   - Interest alignment
   - Weather compatibility
   - Indoor/outdoor suitability
   - Price and budget constraints
4) Construct a realistic daily flow:
   - Morning / afternoon / evening sequencing
   - Reasonable travel times
5) Verify constraints:
   - Every day has at least one activity.
   - No outdoor-only activities are scheduled during rain or adverse weather.
   - Total and per-day costs are internally consistent and within budget.
6) Perform a final consistency check:
   - Dates are correct and contiguous.
   - No hallucinated activities or prices.
   - Output strictly matches the required schema.

Do NOT reveal your reasoning or planning steps.

[Output Format — STRICT]
Respond with ONLY a single valid JSON object.
- No analysis
- No explanations
- No markdown
- No code fences
- No extra text

The JSON MUST conform exactly to the following TravelPlan schema:

```json
{
  "trip_summary": {
    "destination": "<string>",
    "start_date": "<YYYY-MM-DD>",
    "end_date": "<YYYY-MM-DD>",
    "party_size": <int>,
    "interests": ["<string>", "..."],
    "currency": "<ISO currency code>"
  },
  "budget": {
    "total_budget": <number>,
    "estimated_total_cost": <number>,
    "daily_budget_limit": <number|null>,
    "cost_breakdown": [
      {
        "date": "<YYYY-MM-DD>",
        "activities_cost": <number>,
        "transport_cost": <number>,
        "other_cost": <number>,
        "estimated_day_total": <number>
      }
    ],
    "is_within_budget": <true|false>
  },
  "daily_plan": [
    {
      "date": "<YYYY-MM-DD>",
      "weather": {
        "summary": "<string>",
        "precipitation": "<string>",
        "temperature_min_c": <number>,
        "temperature_max_c": <number>
      },
      "activities": [
        {
          "name": "<string>",
          "category": "<string>",
          "indoor": <true|false>,
          "start_time": "<HH:MM>",
          "end_time": "<HH:MM>",
          "location": "<string>",
          "price": <number>,
          "booking_required": <true|false>,
          "notes": "<string>"
        }
      ],
      "transfers": [
        {
          "from": "<string>",
          "to": "<string>",
          "mode": "<string>",
          "estimated_duration_min": <number>,
          "estimated_cost": <number>
        }
      ],
      "backup_options": [
        {
          "name": "<string>",
          "indoor": <true|false>,
          "reason": "<string>"
        }
      ],
      "day_notes": "<string>"
    }
  ],
  "assumptions": ["<string>"],
  "constraints_validation": {
    "has_activity_every_day": <true|false>,
    "avoided_outdoor_on_rain_days": <true|false>,
    "aligned_to_interests": <true|false>,
    "respected_budget": <true|false>,
    "details": ["<string>"]
  }
}

## Context

### Weather Data (records)
{weather_for_dates_df.to_json(orient="records")}

### Activities Data (records)
{activities_for_dates.to_json(orient="records")}
""" 


assert "TASK" in ITINERARY_AGENT_SYSTEM_PROMPT.upper(), "❌ ITINERARY_AGENT_SYSTEM_PROMPT should contain a 'TASK' section"
assert "OUTPUT FORMAT" in ITINERARY_AGENT_SYSTEM_PROMPT.upper(), "❌ ITINERARY_AGENT_SYSTEM_PROMPT should contain a 'OUTPUT FORMAT' section"


class ItineraryAgent(ChatAgent):
    """An agent that plans itineraries based on vacation information, weather, and activities."""
    system_prompt = ITINERARY_AGENT_SYSTEM_PROMPT

    def get_itinerary(self, vacation_info: VacationInfo, model: Optional[OpenAIModel] = None) -> TravelPlan:
        """Generates a travel itinerary based on the provided vacation information."""
        from project_lib import print_in_box
        response = (self.chat(
            user_message=vacation_info.model_dump_json(indent=2),
            add_to_messages=False,
            model=model or self.model,
        ) or "").strip()

        print_in_box(response, "Raw Response")

        # Parse the response
        json_text = response.strip()

        if "```json" in json_text:
            json_text = json_text.split("```json")[1].split("```")[0].strip()

        try:
            travel_plan = TravelPlan.model_validate_json(json_text)
            return travel_plan
        except Exception as e:
            print("Error validating the following text as TravelPlan JSON:")
            print(json_text)
            raise

itinerary_agent = ItineraryAgent(client=client, model=MODEL)
